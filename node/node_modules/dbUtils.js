module.exports = {
    
    /*initialize: function(callback) {
        var host = require('os').hostname();
        var MongoClient = require('mongodb').MongoClient, format = require('util').format;

        MongoClient.connect('mongodb://' + host + ':27017/goalglance', function(err, db) {
            if(err) throw err;
            module.exports.db = db;
            callback();
        });
    },*/

    initialize: function(callback) {
        
        var MongoClient = require('mongodb').MongoClient, format = require('util').format;
        var dbLoc = "";
        if (typeof process.env.MONGOHQ_URL == 'undefined' || process.env.MONGOHQ_URL.length == 0) {
            var host = require('os').hostname();
            dbLoc = 'mongodb://' + host + ':27017/goalglance'    
        } else {
            dbLoc = process.env.MONGOHQ_URL;
        }        
        console.log(dbLoc);
        MongoClient.connect(dbLoc, function(err, db) {
            if(err) throw err;
            module.exports.db = db;
            callback();
        });
    },

    createUser: function(username, email, password) {
            var collection = module.exports.db.collection('users');
            collection.insert({'username': username,
                               'email': email,
                               'password': password,
                               'goal': null,
                               'photos': []
                           }, function(err) {if(err) throw err;});
            // this.checkUser(username, password);
            // needs to check if user exists and re-validate before adding
    },

    changePassword: function(username, email, newPassword) {
        var collection = module.exports.db.collection('users');
        collection.update(
            {
                'username': username,
                'email': email
            },
            { $set: {
                    'password': newPassword
                }

            }, function(err) {
                if (err) throw err;
            });
    },
/*
    getPassword: function(username, callback){
        var collection = module.exports.db.collection('users');
        collection.find({'username': username}).toArray(function(err, results) {
            var email = results[0]['password'];
            callback(password);
        });
    }, */

    getEmail: function(username, callback) {
        var collection = module.exports.db.collection('users');
        collection.find({'username': username}).toArray(function(err, results) {
            var email;
            if (err) {
                email = null;
            } else {
                var email = results[0]['email'];
            }
            callback(email);
        });
    },

    getGoal: function(username, callback) {
        var collection = module.exports.db.collection('users');
        collection.find({'username': username}).toArray(function(err, results) {
            var goal = results[0]['goal'];
            callback(goal);
        });
    },


    setGoal: function(username, newGoal) {
        // if user has a goal, need to delete it and all associated photos
        var collection = module.exports.db.collection('users');
        collection.update(
            {
                'username': username,
            },
            {   $set: {
                    'goal': newGoal,
                    'photos': []
                }

            }, function(err) {
                if (err) throw err;
            });
    },


    retrievePassword: function(username, useremail, successCb, failureCb) {
        var collection = module.exports.db.collection('users');
        collection.find({'username': username}).toArray(function(err, results) {
            if(results.length) {
                  var password = results[0]['password'];
                  var email = results[0]['email'];
                   if(email == useremail) {
                       successCb(password);
                   } else {
                        failureCb();
                   }
            } else{
                failureCb();
            }
          
        });
    },

    checkUser: function(username, password, successCb, failureCb) {
        // Locate all the entries using find
            var collection = module.exports.db.collection('users');
            collection.find({'username': username,
                             'password': password}).toArray(function(err, results) {

                if (results.length) {
                    successCb();
                } else {
                    failureCb();
                }
            });
    },

    checkEmail: function(email, successCb, failureCb) {
        // Locate all the entries using find
            var collection = module.exports.db.collection('users');
            collection.find({'email': email}).toArray(function(err, results) {

                if (results.length) {
                    failureCb();
                } else {
                    successCb();
                }
            });
    },

  checkUsername: function(username, successCb, failureCb) {
        // Locate all the entries using find
            var collection = module.exports.db.collection('users');
            collection.find({'username': username}).toArray(function(err, results) {
                if (results.length) {
                    failureCb();
                } else {
                    successCb();
                }
            });
    },

    addNewContact: function(username, contact) {
        var collection = module.exports.db.collection('users');
        collection.update(
            {'username': username}, 
            { 
                $addToSet: {
                    'contacts': contact
                }
            }
         , function(err) { if (err) throw err;});
    },

    getContacts: function(username, callback) {
       var collection = module.exports.db.collection('users');
       collection.find({'username': username}).toArray(function(err, results) {
            var contacts = results[0]['contacts'];
            callback(contacts);
        });
    },

    deleteContact: function(username, email) {
       var collection = module.exports.db.collection('users');
       collection.update(
            {'username': username}, 
            { 
                $pull: {
                    'contacts': email                    
                }
            }
        , function(err) { if (err) throw err;});
    },

    addPhoto: function(username, photoURL, addedBy) {
        var collection = module.exports.db.collection('users');
        collection.update(
            {'username': username}, 
            { 
                $addToSet: {
                    'photos': {
                    'url': photoURL,
                    'added_at': new Date(),
                    'new': true
                    }
                }
            }
         , function(err) { if (err) throw err;});

    },

    deletePhoto: function(username, photoURL) {
       var collection = module.exports.db.collection('users');
       collection.update(
            {'username': username}, 
            { 
                $pull: {
                    'photos': {
                        'url': photoURL,
                    }
                }
            }
        , function(err) { if (err) throw err;});
    },

    setPhotosSeen: function(username, photoURLs) {

        var collection = module.exports.db.collection('users');
        collection.find({'username': username}).toArray(function(err, results) {
            var photos = results[0]['photos'];
            for (var i=0; i<photos.length; i++) {
                var photo = photos[i];
                if (photo.new) {
                    collection.update(
                    {'username': username}, 
                    { 
                        $pull: {
                            'photos': {
                                'url': photo.url,
                            }
                        }
                    }, function(err) { if (err) throw err;}
                );
                collection.update(
                    {'username': username}, 
                    { 
                        $addToSet: {
                            'photos': {
                            'url': photo.url,
                            'added_at': photo.added_at,
                            'type': photo.type
                            }
                        }
                    }, function(err) { if (err) throw err;}
                );   
                }
            

            }

        });

    },

    getPhotos: function(username, callback) {
       var collection = module.exports.db.collection('users');
       collection.find({'username': username}).toArray(function(err, results) {
            var photos = results[0]['photos'];
            photos.sort(function(a, b) {
                a = new Date(a.added_at);
                b = new Date(b.added_at);
                return a>b ? -1 : a<b ? 1 : 0;
            });
            callback(photos);
        });
    },

    getReminders: function(username, callback) {
       var collection = module.exports.db.collection('users');
       collection.find({'username': username}).toArray(function(err, results) {
            var reminders = results[0]['reminders'];
            callback(reminders);
        });
    }
}