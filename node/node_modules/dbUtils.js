module.exports = {
    
    /*initialize: function(callback) {
        var host = require('os').hostname();
        var MongoClient = require('mongodb').MongoClient, format = require('util').format;

        MongoClient.connect('mongodb://' + host + ':27017/goalglance', function(err, db) {
            if(err) throw err;
            module.exports.db = db;
            callback();
        });
    },*/

    initialize: function(callback) {
        
        var MongoClient = require('mongodb').MongoClient, format = require('util').format;
        var dbLoc = "";
        if (typeof process.env.MONGOHQ_URL == 'undefined' || process.env.MONGOHQ_URL.length == 0) {
            var host = require('os').hostname();
            dbLoc = 'mongodb://' + host + ':27017/goalglance'    
        } else {
            dbLoc = process.env.MONGOHQ_URL;
        }        
        console.log(dbLoc);
        MongoClient.connect(dbLoc, function(err, db) {
            if(err) throw err;
            module.exports.db = db;
            callback();
        });
    },

    createUser: function(username, email, password) {

            var collection = module.exports.db.collection('users');
            collection.insert({'username': username,
                               'email': email,
                               'password': password,
                               'goal': null,
                               'photos': []
                           }, function(err) {if(err) throw err;});
            // this.checkUser(username, password);
            // needs to check if user exists and re-validate before adding

    },

    changePassword: function(username, email, newPassword) {
        var collection = module.exports.db.collection('users');
        collection.update(
            {
                'username': username,
                'email': email
            },
            { $set: {
                    'password': newPassword
                }

            }, function(err) {
                if (err) throw err;
            });
    },

    getEmail: function(username, callback) {
        var collection = module.exports.db.collection('users');
        collection.find({'username': username}).toArray(function(err, results) {
            var email = results[0]['email'];
            callback(email);
        });
    },

    getGoal: function(username, callback) {
        var collection = module.exports.db.collection('users');
        collection.find({'username': username}).toArray(function(err, results) {
            var goal = results[0]['goal'];
            callback(goal);
        });
    },

    setGoal: function(username, newGoal) {
        // if user has a goal, need to delete it and all associated photos
        var collection = module.exports.db.collection('users');
        collection.update(
            {
                'username': username,
            },
            {   $set: {
                    'goal': newGoal,
                    'photos': []
                }

            }, function(err) {
                if (err) throw err;
            });
    },

    checkUser: function(username, password, successCb, failureCb) {
        // Locate all the entries using find
            var collection = module.exports.db.collection('users');
            collection.find({'username': username,
                             'password': password}).toArray(function(err, results) {

                if (results.length) {
                    successCb();
                } else {
                    failureCb();
                }
            });
    },

    // this should take photo data and upload it to s3, then store that link
    addPhoto: function(username, photoData, addedBy) {
        var collection = module.exports.db.collection('users');

        // this is untested and probably doesn't work. test once upload works on frontend
        // var aws = require('aws-sdk');
        // var s3 = new aws.S3();
        //   s3.client.putObject({
        //     Bucket: 'goalglance',
        //     Body: photoData
        //   }, function (resp) {
        //     console.log(resp);
        //     console.log('Successfully uploaded package.');
        //   });

        var url = 'http://www.lorempixel.com/400/400';

        collection.update(
            {'username': username}, 
            { 
                $addToSet: {
                    'photos': {
                    'url': url,
                    'added_at': new Date()
                    }
                }

            }
         , function(err) { if (err) throw err;});
    },

    deletePhoto: function(username, photoURL) {
        // todo
    },

    getPhotos: function(username, callback) {
       var collection = module.exports.db.collection('users');
       collection.find({'username': username}).toArray(function(err, results) {
            var photos = results[0]['photos'];
            callback(photos);
        });
    },

    getReminders: function(username, callback) {
       var collection = module.exports.db.collection('users');
       collection.find({'username': username}).toArray(function(err, results) {
            var reminders = results[0]['reminders'];
            callback(reminders);
        });
    }
}