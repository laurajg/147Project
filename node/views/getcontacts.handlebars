<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery</title>
    <style>
    #contacts {
        overflow-y: scroll;        
    }
    </style>
    <!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->
    <!-- Bootstrap -->
    <link href="css/bootstrap.css" rel="stylesheet" media="screen">   
    <link href="css/bootstrap-responsive.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet" type="text/css">


    <script>
    var contacts = []
    function auth() {
        //gapi.client.setApiKey('AIzaSyAZTAmIwm6ADEok2kSNpNkvMGGkfm6a4as');

        var config = {
          'client_id': '495823667074-6deviilknch8i64peb3t6fem6mn6cuga.apps.googleusercontent.com',
          'scope': 'https://www.google.com/m8/feeds '
      };
      $('#gmailauthorize').val('Loading...');
      gapi.auth.authorize(config, function() {
          console.log('login complete');
          console.log(gapi.auth.getToken());
          $.getJSON('https://www.google.com/m8/feeds/contacts/default/full/?access_token=' + 
           gapi.auth.getToken().access_token + "&alt=json&max-results=1000000&callback=?", function(result){
            //console.log(JSON.stringify(result));

            for (i = 0; i < result.feed.entry.length; i++) {                
                if ('gd$email' in result.feed.entry[i]) {
                    for (j = 0; j < result.feed.entry[i].gd$email.length; j++) {                    
                        contacts.push({'name': result.feed.entry[i].title.$t, 'email': result.feed.entry[i].gd$email[j].address});                            
                    }
                }
            }
            contacts.sort(function (a,b) {
                stra = a.name.length > 0 ? a.name : a.email;
                stra = stra.toLowerCase();
                strb = b.name.length > 0 ? b.name : b.email;
                strb = strb.toLowerCase();    
                if (stra === strb) {
                    stra = a.email.toLowerCase();
                    strb = b.email.toLowerCase();
                }
                if (stra < strb)
                    return -1;
                if (stra > strb) {
                    return 1
                }
                return 0;
            });            
            render_contacts(contacts);
            $('#contactquery').keyup(function() {
                var newcontacts = [];
                var query = $('#contactquery').val();
                for (i = 0; i < contacts.length; i++) {
                    if (contacts[i].name.toLowerCase().indexOf(query.toLowerCase()) != -1 ||
                        contacts[i].email.toLowerCase().indexOf(query.toLowerCase()) != -1) {
                        newcontacts.push(contacts[i]);
                    }
                }
                render_contacts(newcontacts);
            });
            $('#gmailauthorize').hide();
            $('#gmaildiv').css('display','block');
        });

      });
return false;
}
function render_contacts(contacts) {
    //var textcont = '<ol>';
    // for (i=0; i < contacts.length; i++) {
    //     textcont += '<li>'+ contacts[i].name + ' &lt;' + contacts[i].email + '&gt;</li>\n';
    // }
    // textcont += '</ol>'
    // $('#contacts').html(textcont);

    $('#contactslist').html('');
    for (i = 0; i < contacts.length; i++) {
        var cur = contacts[i];                
        $('#contactslist')
             .append($("<option></option>")
             .attr("value",cur.email)
             .text(cur.name + ' <' + cur.email + '>')); 
    }  
}
function startup() {
    enablebutton();
    $('#contactslist').change(function() {
        var selecteditem = $(this).find(':selected');
        if (selecteditem.length > 0) {
            $('#contactquery').val(selecteditem.val());
        }
    });
}
function enablebutton() {
  $('#gmailauthorize').removeAttr('disabled');
}
    </script>
  </head>

  
<body onload='javascript:startup()'>    
    {{>navigation}}
    <div id="main">
        <p>Please enter the email address of a person you'd like to share with:</p>
        <form action='/addContact' method='get'>
        <p><input type='text' id='contactquery' name='contactemail'></input></p>
        <p>
        <input class="submitButton" type="submit" value="Load Gmail Contacts to Search..." disabled id='gmailauthorize' onclick="auth(); return false;" style="margin-bottom: 15%">
        </p>
        <div id='gmaildiv' style='display:none'>
        <p>Matching Gmail Contacts:</p>
        <select id='contactslist' size=6 style="margin-bottom: 10%; height: 40%">
        </select>
        </div>
        <p><input class = "submitButton" type="submit" value="Share with this email address"></p></form>
        <script src="https://apis.google.com/js/client.js"></script>

    </div>
    {{>footer}}

    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="js/jquery-1.11.0.js"> </script>
    <script src="js/bootstrap.js"> </script>
    <script src="js/hci-friends.js"> </script>    
</body>
</html>
